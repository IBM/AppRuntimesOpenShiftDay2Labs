<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>High CPU - App Runtimes OpenShift Labs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link href="../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "High CPU";
        var mkdocs_page_input_path = "lab_liberty_high_cpu.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]--> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> App Runtimes OpenShift Labs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">OpenShift Fundamentals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_basics_containers/">Kubernetes basics</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">WebSphere Liberty on OpenShift</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_applogs/">Application logs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_diagnostic_trace/">Diagnostic trace</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">High CPU</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_high_http_response_times/">High response times</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_application_errors/">Application errors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_java_oome/">Java OutOfMemoryErrors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_instanton/">InstantOn</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">General OpenShift Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_basics_openshift_health/">Health of the cluster</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_pipelines/">Pipelines</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../appendix/">End of labs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_support/">Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../faq/">Frequently Asked Questions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../openshift_login_commandline/">OpenShift command line access</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_install_app/">Install Sample Liberty Application</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_liberty_uninstall_app/">Uninstall Sample Liberty Application</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lab_administration/">Lab cluster administration</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">App Runtimes OpenShift Labs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>WebSphere Liberty on OpenShift &raquo;</li>
      <li>High CPU</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-high-cpu">Lab: High CPU</h1>
<p>This lab covers how to investigate high CPU for a sample Liberty application in OpenShift.</p>
<h2 id="theory">Theory</h2>
<p>There are many ways to review high CPU for Liberty in an OpenShift environment:</p>
<ol>
<li>Review verbose garbage collection during the issue to check for a high proportion of time in garbage collection</li>
<li>Manually gather thread dumps during the issue by opening a terminal in the container and executing <code>kill -3 $PID</code></li>
<li>If the application is installed using the WebSphere Liberty Operator, the <a href="https://www.ibm.com/docs/en/was-liberty/base?topic=resources-webspherelibertydump-custom-resource">WebSphereLibertyDump custom resource</a> may be used to gather a <a href="https://openliberty.io/docs/latest/reference/command/server-dump.html">Liberty server dump</a> with a thread dump. This only works if the <code>WebSphereLibertyApplication</code> custom resource has the proper <a href="https://www.ibm.com/docs/en/was-liberty/base?topic=resources-webspherelibertydump-custom-resource"><code>openliberty.io/day2operations</code> annotation</a>, and if the container has a <a href="https://www.ibm.com/docs/en/was-liberty/base?topic=operator-storage-serviceability"><code>/serviceability</code> directory</a>.</li>
<li>If you have <code>cluster-admin</code> permissions, use the <a href="https://www.ibm.com/support/pages/mustgather-performance-hang-or-high-cpu-issues-websphere-application-server-linux-containers">MustGather: Performance, hang, or high CPU issues with WebSphere Application Server on Linux on Containers</a> during the issue and search for repeating patterns in thread dumps</li>
<li>If running IBM Java 8, gather a headless mode HealthCenter Java sampling profiler collection</li>
<li>If you have <code>cluster-admin</code> permissions, gather a Linux <code>perf</code> native sampling profiler collection</li>
<li>Run <code>top -H</code> to review per-thread CPU utilization, if the container image includes the <code>top</code> utility</li>
<li>Use third-party monitoring products such as <a href="https://www.instana.com/supported-technologies/websphere-liberty/">Instana</a></li>
</ol>
<p>This lab will only cover some of the above methods.</p>
<h2 id="labs">Labs</h2>
<p>Choose one or more labs:</p>
<ol>
<li><a href="#lab-manually-gather-thread-dumps-during-the-issue">Lab: Manually gather thread dumps during the issue</a></li>
<li><a href="#lab-use-the-performancehanghigh-cpu-mustgather-on-linux-on-containers">Lab: Use the performance/hang/high CPU MustGather on Linux on Containers</a></li>
<li>You could also gather a <code>server dump</code> as done in the <a href="../lab_liberty_high_http_response_times/#lab-gather-a-liberty-server-dump-through-the-websphere-liberty-operator">High response times lab</a></li>
</ol>
<hr />
<h2 id="lab-manually-gather-thread-dumps-during-the-issue">Lab: Manually gather thread dumps during the issue</h2>
<p>This lab will gather thread dumps showing accumulated CPU by thread and associated stacks. Any statistical patterns in thread stacks associated with high CPU threads may be used to infer potential causes of high CPU.</p>
<p>This method is generally used when there is persistently high CPU. If CPU spikes are infrequent, then this technique is more difficult unless you capture a lot of thread dumps.</p>
<p>This lab will take approximately 10 minutes.</p>
<h3 id="step-1-install-example-application">Step 1: Install example application</h3>
<p>If you haven't already, <a href="../lab_liberty_install_app/">install the sample application</a>. If you installed it in a previous lab, you may continue using the previous installation.</p>
<h3 id="step-2-exercise-high-cpu">Step 2: Exercise high CPU</h3>
<p>You will simulate 5 concurrent users sending HTTP requests that perform CPU intensive operations such as compiling regular expressions and performing mathematical operations.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>Request the following web page from your terminal to exercise high CPU:</p>
<ol>
<li>
<p>macOS, Linux, or Windows with Cygwin:</p>
<pre><code>curl -k -s "https://$(oc get route libertydiag "--output=jsonpath={.spec.host}")/servlet/LoadRunner?url=http%3A%2F%2Flocalhost%3A9080%2Fservlet%2FDoComplicatedStuff%3Fmoreiterations%3Dtrue&amp;method=get&amp;entity=&amp;concurrentusers=5&amp;totalrequests=0&amp;user=&amp;password=&amp;infinite=on"
</code></pre>
</li>
<li>
<p>Windows with Command Prompt:</p>
<ol>
<li>Ensure you have <a href="https://curl.se/windows/"><code>curl</code> for Windows</a> installed</li>
<li>
<p>List the application's URL:</p>
<pre><code>oc get route libertydiag "--output=jsonpath={.spec.host}{'\n'}"
</code></pre>
</li>
<li>
<p>Execute the following command, replacing <code>$HOST</code> with the output of the previous command:</p>
<pre><code>curl -k -s "https://$HOST/servlet/LoadRunner?url=http%3A%2F%2Flocalhost%3A9080%2Fservlet%2FDoComplicatedStuff%3Fmoreiterations%3Dtrue&amp;method=get&amp;entity=&amp;concurrentusers=5&amp;totalrequests=0&amp;user=&amp;password=&amp;infinite=on"
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>This load will run indefinitely. Continue to the next step.</p>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>Click on the <code>Load Runner</code> link from the libertydiag application homepage:<br />
<img alt="" src="../images/loadrunner.png" /></li>
<li>
<p>In the <code>Target URL</code>, copy and paste the following:</p>
<pre><code>http://localhost:9080/servlet/DoComplicatedStuff?moreiterations=true
</code></pre>
</li>
<li>
<p>Scroll down and check <code>Infinite (until manually stopped)</code></p>
</li>
<li>Scroll to the bottom and click <code>Start</code></li>
<li>This load will run indefinitely. Continue to the next step.</li>
</ol>
</details>
<h3 id="step-3-manually-gather-thread-dumps">Step 3: Manually gather thread dumps</h3>
<p>Now you will gather a number of thread dumps.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>List the pods for the example application deployment; for example:</p>
<pre><code>oc get pods
</code></pre>
<p>Example output:</p>
<pre><code>NAME                          READY   STATUS    RESTARTS   AGE
libertydiag-b98748954-mgj64   1/1     Running   0          97s
</code></pre>
</li>
<li>
<p>Open a shell into the pod by replacing <code>$POD</code> with a pod name from the previous command:</p>
<pre><code>oc rsh -t $POD
</code></pre>
<p>For example:</p>
<pre><code>oc rsh -t libertydiag-b98748954-mgj64
</code></pre>
</li>
<li>
<p>Note that the remote shell might timeout after a short period of inactivity, so be aware that you might have been logged out and you'll need to <code>oc rsh</code> back in to continue where you left off.</p>
</li>
<li>
<p>First, we need to find the process ID (PID) of Liberty. Most Liberty images do not have tools like <code>ps</code> or <code>top</code> pre-installed. However, most Liberty images only have a single process in the container which is the Java process running Liberty, and this has the PID of 1. Double check that this is the Liberty process by doing a full listing on PID 1:</p>
<pre><code>ls -l /proc/1/
</code></pre>
</li>
<li>
<p>If you see a Liberty current working directory (<code>cwd</code>) such as <code>/opt/ol/wlp</code> or <code>/opt/ibm/wlp</code> then you can assume that is the Liberty process. Otherwise, run <code>ls -l /proc/[0-9]*</code> and then explore each PID to find the Liberty process.</p>
<pre><code>ls -l /proc/1
</code></pre>
<p>Example output:</p>
<pre><code>[...]
lrwxrwxrwx.  1 1000830000 root 0 Dec  6 17:45 cwd -&gt; /opt/ibm/wlp/output/defaultServer
-r--------.  1 1000830000 root 0 Dec  6 17:45 environ
lrwxrwxrwx.  1 1000830000 root 0 Dec  6 14:57 exe -&gt; /opt/ibm/java/jre/bin/java
[...]
</code></pre>
</li>
<li>
<p>Create a thread dump by sending the <code>SIGQUIT</code> signal to the process using the <code>kill -QUIT $PID</code> command. Replace <code>$PID</code> with the process ID of Liberty that you found above. Note that, by default, Java handles the <code>SIGQUIT</code> signal, creates the thread dump, and the process continues, so the process is not killed, despite the names of the command and signal.</p>
<pre><code>kill -QUIT 1
</code></pre>
</li>
<li>
<p>It's common to wait about 30 seconds between thread dumps. Take another 1 or more thread dumps, waiting some time in between.</p>
<pre><code>kill -QUIT 1
</code></pre>
</li>
<li>
<p>Normally, thread dumps for IBM Java and Semeru will be produced as <code>javacore*txt</code> files in the <code>cwd</code> directory that you found above:</p>
<pre><code>ls -l /opt/ibm/wlp/output/defaultServer/javacore*txt
</code></pre>
<p>However, in the case of this sample application, this directory is overridden with an <code>-Xdump</code> configuration. You can check JVM configurations by printing the process <code>cmdline</code> and <code>environ</code> files and find the relevant configuration. For example:</p>
<pre><code>cat /proc/1/cmdline /proc/1/environ
</code></pre>
<p>Example output:</p>
<pre><code>[...] -Xdump:directory=logs/diagnostics/
</code></pre>
<p>Therefore, for this application, javacores will go into <code>logs/diagnostics/</code> relative to <code>cwd</code>:</p>
<pre><code>ls /opt/ibm/wlp/output/defaultServer/logs/diagnostics/javacore*txt
</code></pre>
<p>Example output:</p>
<pre><code>/opt/ibm/wlp/output/defaultServer/logs/diagnostics/javacore.20221206.175535.1.0001.txt
/opt/ibm/wlp/output/defaultServer/logs/diagnostics/javacore.20221206.175626.1.0002.txt
</code></pre>
<p>Note that overridding the <code>-Xdump</code> directory is common in container deployments so that a directory may be used that's mounted on a permanent disk so that diagnostics are still available if a pod is killed.</p>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>In the <code>Topology</code> view of the <a href="../openshift_perspective/"><code>Developer</code> perspective</a>, click on the <code>libertydiag</code> circle, then click the <code>Resources</code> tab in the drawer on the right, and then click on the one pod that's running:<br />
<img alt="" src="../images/topology_selectpod.png" /></li>
<li>Click on the <code>Terminal</code> tab to open a remote shell into the running container in the pod:<br />
<img alt="" src="../images/pod_terminal.png" /></li>
<li>Follow the <code>Using the command line</code> steps above starting at step 4.</li>
</ol>
</details>
<h3 id="step-4-download-thread-dumps">Step 4: Download thread dumps</h3>
<details>
<summary>Using the command line</summary>
<ol>
<li>Download the thread dumps by replacing <code>$POD</code> with a pod name from above and <code>$DIR</code> with the directory of the javacores. Note that <code>oc cp</code> does not support wildcards so the whole directory (or a single file) must be downloaded.<pre><code>oc cp $POD:$DIR .
</code></pre>
<p>For example:</p>
<pre><code>oc cp libertydiag-ddf5f95b6-wj6dm:/opt/ibm/wlp/output/defaultServer/logs/diagnostics .
</code></pre>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<p>Files other than native logs (equivalent to Liberty's <code>console.log</code>) cannot be downloaded through the browser. You must use the command line steps above. Alternatively, you may use the <code>Terminal</code> tab of the pod and <code>cat</code> the file in the browser.</p>
</details>
<h3 id="step-5-analyze-the-thread-dumps">Step 5: Analyze the thread dumps</h3>
<p>If you are familiar with analyzing thread dumps for high CPU, you may skip this step.</p>
<details>
<summary>Review thread dumps</summary>
<ol>
<li>
<p>Open each thread dump and search for <code>Thread Details</code>:</p>
<pre><code>1XMTHDINFO     Thread Details
</code></pre>
</li>
<li>
<p>Review each thread (starting with <code>3XMTHREADINFO</code>) and, in particular, the <code>3XMCPUTIME</code> line:</p>
<pre><code>3XMTHREADINFO      "Default Executor-thread-189" J9VMThread:0x00000000002BA700, omrthread_t:0x00007F7FD0014240, java/lang/Thread:0x00000000E43D62C0, state:R, prio=5
[...]
3XMCPUTIME               CPU usage total: 6.839021278 secs, current category="Application"
</code></pre>
</li>
<li>
<p>The <code>CPU usage total</code> is accumulated CPU usage since the beginning of that thread. Therefore, finding high users of CPU is most commonly done by comparing these values across thread dumps for particular threads. Note that if a thread is short-lived, then it may not be captured in the thread dumps, or may only exist in a subset of thread dumps.</p>
</li>
<li>With a sufficient number of thread dumps and a persistent pattern of stack tops for high CPU threads, this may be used to hypothesize likely causes of high CPU. In this case, there is a peristent pattern of application stacks in the <code>DoComplicatedStuff.doWork</code> method driving code such as mathematical operations, regular expression compilation, etc. For example:<pre><code>3XMTHREADINFO3           Java callstack:
4XESTACKTRACE                at java/math/BigInteger.cutOffLeadingZeroes(BigInteger.java:1505(Compiled Code))
4XESTACKTRACE                at java/math/Division.divideAndRemainderByInteger(Division.java:344(Compiled Code))
4XESTACKTRACE                at java/math/BigInteger.divideAndRemainder(BigInteger.java:1202(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.slScaledDivide(BigDecimal.java:3489(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2446(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2424(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2389(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.arctan(DoComplicatedStuff.java:141(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.computePi(DoComplicatedStuff.java:119(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.doWork(DoComplicatedStuff.java:60(Compiled Code))
</code></pre>
</li>
</ol>
</details>
<h3 id="step-6-clean-up">Step 6: Clean-up</h3>
<p>The pod will be using a lot of CPU, so you will kill the pod. Kubernetes will automatically create a new replacement pod in preparation for the next lab.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>List the pods; for example:</p>
<pre><code>oc get pods
</code></pre>
<p>Example output:</p>
<pre><code>NAME                          READY   STATUS    RESTARTS   AGE
libertydiag-b98748954-mgj64   1/1     Running   0          97s
</code></pre>
</li>
<li>
<p>Kill the running pod by replacing <code>$POD</code> with a pod name from the previous command:</p>
<pre><code>oc delete pod $POD
</code></pre>
<p>For example:</p>
<pre><code>oc delete pod libertydiag-b98748954-mgj64
</code></pre>
</li>
<li>
<p>Wait for the replacement pod to come up:</p>
<pre><code>oc wait deployment libertydiag --for condition=available --timeout=5m
</code></pre>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>In the <code>Topology</code> view of the <a href="../openshift_perspective/"><code>Developer</code> perspective</a>, click on the <code>libertydiag</code> circle, then click the <code>Resources</code> tab in the drawer on the right, and then click on the one pod that's running:<br />
<img alt="" src="../images/topology_selectpod.png" /></li>
<li>In the top right, click Actions } Delete Pod</li>
<li>While the new pod is initializing, there will be a light blue circle around the deployment. Wait until the circle turns into a dark blue, signifying the application is ready. This may take up to 2 minutes or more depending on available cluster resources and namespace limits.</li>
</ol>
</details>
<h3 id="summary">Summary</h3>
<p>In summary, this lab demonstrated how to manually gather thread dumps for Liberty running in a container and review CPU utilization by thread over time. With a sufficient number of thread dumps and a persistent pattern of stack tops for high CPU threads, this may be used to hypothesize likely causes of high CPU.</p>
<hr />
<h2 id="lab-use-the-performancehanghigh-cpu-mustgather-on-linux-on-containers">Lab: Use the performance/hang/high CPU MustGather on Linux on Containers</h2>
<p>This lab will use IBM Support's <a href="https://www.ibm.com/support/pages/mustgather-performance-hang-or-high-cpu-issues-websphere-application-server-linux-containers">MustGather: Performance, hang, or high CPU issues with WebSphere Application Server on Linux on Containers</a> to gather thread dumps showing any requests being processed. Any statistical patterns in thread stacks may be used to infer potential causes of high CPU. This MustGather is publicly available and nearly the same as the <a href="https://www.ibm.com/support/pages/mustgather-performance-hang-or-high-cpu-issues-websphere-application-server-linux">standalone Linux performance/hang/high-CPU MustGather</a> in that it gathers CPU, memory, disk, network information, thread dumps, etc., and customers should be encouraged to use it if they can accept that it requires <code>cluster-admin</code> permissions to execute.</p>
<p>This lab will demonstrate how to execute the MustGather, download the diagnostics, and review them for potential causes of high CPU.</p>
<p><strong>Note</strong>: This lab requires that the user has <code>cluster-admin</code> permissions. A future version of the MustGather will not require administrator permissions.</p>
<p>This lab will take approximately 10 minutes.</p>
<h3 id="step-0-check-if-you-have-cluster-admin-permissions">Step 0: Check if you have cluster-admin permissions</h3>
<p>These steps will show if you have <code>cluster-admin</code> permissions. If you do not, you must skip this lab.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>Check if you have authority for all verbs on all resources:</p>
<pre><code>oc auth can-i '*' '*'
</code></pre>
<p>Example output:</p>
<pre><code>yes
</code></pre>
</li>
<li>
<p>If the answer is <code>no</code>, then you do not have <code>cluster-admin</code> permissions.</p>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>Access your OpenShift web console at <code>https://console-openshift-console.$CLUSTER/</code>. Replace <code>$CLUSTER</code> with your OpenShift cluster domain.</li>
<li>Ensure the perspective is set to <code>Administrator</code> in the top left:<br />
<img alt="" src="../images/adminperspective.png" /></li>
<li>Expand <code>User Management</code>. If you don't see a <code>Users</code> option, then you do not have <code>cluster-admin</code> permissions. If you do see it, click on it, and then click on your user name:<br />
<img alt="" src="../images/users.png" /></li>
<li>Click on <code>RoleBindings</code> and check if any binding has a <code>Role ref</code> of <code>cluster-admin</code>. If there are none, then you do not have <code>cluster-admin</code> permissions.<br />
<img alt="" src="../images/clusteradmin.png" /></li>
</ol>
</details>
<h3 id="step-1-install-example-application_1">Step 1: Install example application</h3>
<p>If you haven't already, <a href="../lab_liberty_install_app/">install the sample application</a>. If you installed it in a previous lab, you may continue using the previous installation.</p>
<h3 id="step-2-exercise-high-cpu_1">Step 2: Exercise high CPU</h3>
<p>You will simulate 5 concurrent users sending HTTP requests that perform CPU intensive operations such as compiling regular expressions and performing mathematical operations.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>Request the following web page from your terminal to exercise high CPU:</p>
<ol>
<li>
<p>macOS, Linux, or Windows with Cygwin:</p>
<pre><code>curl -k -s "https://$(oc get route libertydiag "--output=jsonpath={.spec.host}")/servlet/LoadRunner?url=http%3A%2F%2Flocalhost%3A9080%2Fservlet%2FDoComplicatedStuff%3Fmoreiterations%3Dtrue&amp;method=get&amp;entity=&amp;concurrentusers=5&amp;totalrequests=0&amp;user=&amp;password=&amp;infinite=on"
</code></pre>
</li>
<li>
<p>Windows with Command Prompt:</p>
<ol>
<li>Ensure you have <a href="https://curl.se/windows/"><code>curl</code> for Windows</a> installed</li>
<li>
<p>List the application's URL:</p>
<pre><code>oc get route libertydiag "--output=jsonpath={.spec.host}{'\n'}"
</code></pre>
</li>
<li>
<p>Execute the following command, replacing <code>$HOST</code> with the output of the previous command:</p>
<pre><code>curl -k -s "https://$HOST/servlet/LoadRunner?url=http%3A%2F%2Flocalhost%3A9080%2Fservlet%2FDoComplicatedStuff%3Fmoreiterations%3Dtrue&amp;method=get&amp;entity=&amp;concurrentusers=5&amp;totalrequests=0&amp;user=&amp;password=&amp;infinite=on"
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>This load will run indefinitely. Continue to the next step.</p>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>Click on the <code>Load Runner</code> link from the libertydiag application homepage:<br />
<img alt="" src="../images/loadrunner.png" /></li>
<li>
<p>In the <code>Target URL</code>, copy and paste the following:</p>
<pre><code>http://localhost:9080/servlet/DoComplicatedStuff?moreiterations=true
</code></pre>
</li>
<li>
<p>Scroll down and check <code>Infinite (until manually stopped)</code></p>
</li>
<li>Scroll to the bottom and click <code>Start</code></li>
<li>This load will run indefinitely. Continue to the next step.</li>
</ol>
</details>
<h3 id="step-3-execute-the-mustgather">Step 3: Execute the MustGather</h3>
<p>Now you will execute the MustGather. This takes approximately 6 minutes to run.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>Download a helper script:<ol>
<li>macOS or Linux: <a href="https://github.com/IBM/containerdiag/releases/download/0.1.20230301/containerdiag.sh">containerdiag.sh</a></li>
<li>Windows: <a href="https://github.com/IBM/containerdiag/releases/download/0.1.20230301/containerdiag.bat">containerdiag.bat</a></li>
</ol>
</li>
<li>Open a <code>Terminal</code> or <code>Command Prompt</code> and change directory to where you downloaded the script</li>
<li>
<p>On macOS or Linux, make the script executable:</p>
<pre><code>chmod +x containerdiag.sh
</code></pre>
</li>
<li>
<p>On macOS, remove the download quarantine:</p>
<pre><code>xattr -d com.apple.quarantine containerdiag.sh
</code></pre>
</li>
<li>
<p>List the current deployments:</p>
<pre><code>oc get deployments
</code></pre>
<p>Example output:</p>
<pre><code>NAME          READY   UP-TO-DATE   AVAILABLE   AGE
libertydiag   1/1     1            1           13m
</code></pre>
</li>
<li>
<p>Execute the MustGather. Normally, the <code>-c</code> option specifying the directory of the javacores is not needed; however, this sample application overrides the default javacore directory using <code>-Xdump</code>. This is common in container deployments so that a directory may be used that's mounted on a permanent disk so that diagnostics are still available if a pod is killed.</p>
<ol>
<li>
<p>macOS or Linux:</p>
<pre><code>./containerdiag.sh -d libertydiag libertyperf.sh -c "/opt/ibm/wlp/output/defaultServer/logs/diagnostics/javacore*"
</code></pre>
</li>
<li>
<p>Windows:</p>
<pre><code>containerdiag.bat -d libertydiag libertyperf.sh -c "/opt/ibm/wlp/output/defaultServer/logs/diagnostics/javacore*"
</code></pre>
</li>
</ol>
</li>
<li>
<p>When the MustGather is complete, you will see a repeating message of the form:</p>
<pre><code>run.sh: Files are ready for download. Download with the following command in another window:

  oc cp [...]
</code></pre>
</li>
<li>
<p>Open another <code>Terminal</code> or <code>Command Prompt</code> and copy &amp; paste the <code>oc cp</code> line that you saw in the previous step. For example (your command will be different):</p>
<pre><code>$ oc cp worker4-debug:/tmp/containerdiag.SN9RbwVmfC.tar.gz containerdiag.SN9RbwVmfC.tar.gz --namespace=openshift-debug-node-g8dqbdfx5d
tar: Removing leading `/' from member names
</code></pre>
</li>
<li>
<p>Go back to the previous <code>Terminal</code> or <code>Command Prompt</code>, type <code>ok</code>, and press <code>Enter</code> to complete the MustGather:</p>
<pre><code>After the download is complete, type OK and press ENTER: ok
[2022-11-08 19:01:03.670923238 UTC] run.sh: Processing finished. Deleting /tmp/containerdiag.SN9RbwVmfC.tar.gz
[2022-11-08 19:01:03.674236286 UTC] run.sh: finished.
</code></pre>
</li>
<li>
<p>Expand the <code>containerdiag.*.tar.gz</code> file that you downloaded.</p>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<p>The MustGather cannot be executed from the browser. You must use the command line steps above.browser.</p>
</details>
<h3 id="step-4-analyze-the-thread-dumps">Step 4: Analyze the thread dumps</h3>
<p>If you are familiar with analyzing thread dumps for high CPU, you may skip this step.</p>
<details>
<summary>Review the MustGather data</summary>
<ol>
<li>First, review the <code>top -H</code> output to see CPU utilization by thread. Expand <code>linperf_RESULTS.tar.gz</code> in the root directory and then review <code>topdashH*.out</code>.</li>
<li>
<p>Open each thread dump under <code>pods/libertydiag*/containers/libertydiag/</code> and search for <code>Thread Details</code>:</p>
<pre><code>1XMTHDINFO     Thread Details
</code></pre>
</li>
<li>
<p>Review each thread (starting with <code>3XMTHREADINFO</code>) and, in particular, the <code>3XMCPUTIME</code> line:</p>
<pre><code>3XMTHREADINFO      "Default Executor-thread-189" J9VMThread:0x00000000002BA700, omrthread_t:0x00007F7FD0014240, java/lang/Thread:0x00000000E43D62C0, state:R, prio=5
[...]
3XMCPUTIME               CPU usage total: 6.839021278 secs, current category="Application"
</code></pre>
</li>
<li>
<p>The <code>CPU usage total</code> is accumulated CPU usage since the beginning of that thread. Therefore, finding high users of CPU is most commonly done by comparing these values across thread dumps for particular threads. Note that if a thread is short-lived, then it may not be captured in the thread dumps, or may only exist in a subset of thread dumps.</p>
</li>
<li>With a sufficient number of thread dumps and a persistent pattern of stack tops for high CPU threads, this may be used to hypothesize likely causes of high CPU. In this case, there is a peristent pattern of application stacks in the <code>DoComplicatedStuff.doWork</code> method driving code such as mathematical operations, regular expression compilation, etc. For example:<pre><code>3XMTHREADINFO3           Java callstack:
4XESTACKTRACE                at java/math/BigInteger.cutOffLeadingZeroes(BigInteger.java:1505(Compiled Code))
4XESTACKTRACE                at java/math/Division.divideAndRemainderByInteger(Division.java:344(Compiled Code))
4XESTACKTRACE                at java/math/BigInteger.divideAndRemainder(BigInteger.java:1202(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.slScaledDivide(BigDecimal.java:3489(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2446(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2424(Compiled Code))
4XESTACKTRACE                at java/math/BigDecimal.divide(BigDecimal.java:2389(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.arctan(DoComplicatedStuff.java:141(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.computePi(DoComplicatedStuff.java:119(Compiled Code))
4XESTACKTRACE                at com/example/servlet/DoComplicatedStuff.doWork(DoComplicatedStuff.java:60(Compiled Code))
</code></pre>
</li>
</ol>
</details>
<h3 id="step-5-clean-up">Step 5: Clean-up</h3>
<p>The pod will be using a lot of CPU, so you will kill the pod. Kubernetes will automatically create a new replacement pod in preparation for the next lab.</p>
<details>
<summary>Using the command line</summary>
<ol>
<li>
<p>List the pods; for example:</p>
<pre><code>oc get pods
</code></pre>
<p>Example output:</p>
<pre><code>NAME                          READY   STATUS    RESTARTS   AGE
libertydiag-b98748954-mgj64   1/1     Running   0          97s
</code></pre>
</li>
<li>
<p>Kill the running pod by replacing <code>$POD</code> with a pod name from the previous command:</p>
<pre><code>oc delete pod $POD
</code></pre>
<p>For example:</p>
<pre><code>oc delete pod libertydiag-b98748954-mgj64
</code></pre>
</li>
<li>
<p>Wait for the replacement pod to come up:</p>
<pre><code>oc wait deployment libertydiag --for condition=available --timeout=5m
</code></pre>
</li>
</ol>
</details>
<details>
<summary>Using the browser</summary>
<ol>
<li>In the <code>Topology</code> view of the <a href="../openshift_perspective/"><code>Developer</code> perspective</a>, click on the <code>libertydiag</code> circle, then click the <code>Resources</code> tab in the drawer on the right, and then click on the one pod that's running:<br />
<img alt="" src="../images/topology_selectpod.png" /></li>
<li>In the top right, click Actions } Delete Pod</li>
<li>While the new pod is initializing, there will be a light blue circle around the deployment. Wait until the circle turns into a dark blue, signifying the application is ready. This may take up to 2 minutes or more depending on available cluster resources and namespace limits.</li>
</ol>
</details>
<h3 id="summary_1">Summary</h3>
<p>In summary, this lab demonstrated how to execute the <a href="https://www.ibm.com/support/pages/mustgather-performance-hang-or-high-cpu-issues-websphere-application-server-linux-containers">performance/hang/high CPU MustGather on Linux on Containers</a>, download the diagnostics, and review them for high CPU usage. With a sufficient number of thread dumps and a persistent pattern of stack tops for high CPU threads, this may be used to hypothesize likely causes of high CPU.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../lab_liberty_diagnostic_trace/" class="btn btn-neutral float-left" title="Diagnostic trace"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../lab_liberty_high_http_response_times/" class="btn btn-neutral float-right" title="High response times">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../lab_liberty_diagnostic_trace/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../lab_liberty_high_http_response_times/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/popper.min.js" defer></script>
      <script src="../js/tippy-bundle.umd.js" defer></script>
      <script src="../js/clipboard.js" defer></script>
      <script src="../js/extra.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
